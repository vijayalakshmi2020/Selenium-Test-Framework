pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // Pulls your code from GitHub
                checkout scm
            }
        }

        stage('Execute OrangeHRM Tests') {
            steps {
                echo 'Navigating to OrangeHRMProject and running Maven...'
                
                // 1. Move into the folder where your pom.xml is located
                dir('OrangeHRMProject') {
                    script {
                        // 2. Define the absolute path to your maven executable
                        def mavenPath = 'C:\\apache-maven-3.9.12\\bin\\mvn.cmd'
                        
                        // 3. Run the test command
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat "${mavenPath} clean test -Dbrowser=chrome -Dheadless=true"
                        }
                    }
                }
            }
        }

        stage('Publish Reports') {
            steps {
                echo 'Generating Extent and JUnit Reports...'
                
                // Publish the ExtentReport.html from your specific path
                publishHTML([
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'OrangeHRMProject/src/test/resources/ExtentReports',
                    reportFiles: 'ExtentReport.html',
                    reportName: 'OrangeHRM Extent Report'
                ])

                // Publish JUnit results for Jenkins trend graphs
                dir('OrangeHRMProject') {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
    }

    post {
        always {
            echo 'Archiving report as a build artifact...'
            archiveArtifacts artifacts: '**/ExtentReports/ExtentReport.html', allowEmptyArchive: true
        }
    }
}